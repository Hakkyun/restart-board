<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
	<meta charset="UTF-8">
	<title>결제 페이지</title>
	<link rel="icon" href="https://static.toss.im/icons/png/4x/icon-toss-logo.png" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
	<style>
		.sec { background:#fff; border-radius:12px; border:1px solid #e5e7eb; }
    	.sec-hd { display:flex; align-items:center; gap:.5rem; padding:12px 16px; border-bottom:1px solid #eee; }
    	.num { width:28px; height:28px; border-radius:50%; background:#2051ff; color:#fff;
			   display:inline-flex; align-items:center; justify-content:center; font-weight:700; font-size:.9rem; }
		.thumb-16x9 { aspect-ratio:16/9; object-fit:cover; width:100%; border-radius:8px; }
		.paybtn { height:48px; font-weight:700; }
		.method-card { border:1px solid #e5e7eb; border-radius:10px; }
		.method-card input[type="radio"] { display:none; }
		.method-card label { display:block; padding:12px 16px; cursor:pointer; }
		.method-card input:checked + label { border:2px solid #2051ff; border-radius:10px; }
		.section-head { background-color:#f1f4f6; }
	</style>
	<!-- 토스페이먼츠 SDK 추가 -->
	<script src="https://js.tosspayments.com/v2/standard"></script>
</head>
<body class="bg-light">

	<div class="container py-4">
		<h3 class="fw-bold mb-4">결제 페이지</h3>
		
		<form>
			<div class="row g-4">
				<!-- 좌측 -->
				<div class="col-lg-8">
		
					<!-- 1. 물품 정보 -->
					<section class="sec">
						<div class="sec-hd section-head">
							<span class="num">1</span><span class="fw-semibold">물품 정보</span>
						</div>
						<div class="p-3">
							<div class="row g-3 align-items-start">
								<div class="col-md-6">
									<img th:src="@{/image/guitar.jfif}" alt="상품 이미지" class="thumb-16x9">
									<!-- th:src="@{${item.mainImage}}" -->
								</div>
								<div class="col-md-6">
									<div class="mb-1 text-muted small">물품명</div>
									<div class="fw-semibold" th:text="${product.productName}">일렉기타 픽업</div>
									<!-- th:text="${item.title}" -->
		
									<div class="mt-3 text-muted small">판매자</div>
									<div th:text="${product.userName}">골롬플라이</div> <!-- th:text="${item.sellerName}" -->
		
									<div class="mt-3 text-muted small">가격</div>
									<div class="fs-5 fw-bold"
										th:text="${#numbers.formatInteger(product.productUnitPrice, 0)} + '원'">100,000원</div>
									<!-- th:text="${#numbers.formatInteger(item.productUnitPrice, 0)} + '원'" -->
								</div>
							</div>
						</div>
					</section>
		
					<!-- 2. 배송지 정보 -->
					<section class="sec mt-3">
						<div class="sec-hd section-head">
							<span class="num">2</span><span class="fw-semibold">배송지 정보</span>
						</div>
						<div class="p-3">
							<div class="form-check mb-3">
								<input class="form-check-input" type="checkbox" id="directTrade">
								<!-- th:field="*{directTrade}" -->
								<label class="form-check-label" for="directTrade">
									<strong>대면 거래</strong> (대면 거래 시 배송비는 결제하지 않습니다.)
								</label>
							</div>
		
							<!-- 배송지 정보는 유저 기본 정보를 받아오는걸로?? -->
							<div class="row g-3" id="shipFields">
								<div class="col-md-6">
									<label class="form-label">받는사람</label>
									<input class="form-control" type="text" placeholder="">
								</div>
								<div class="col-md-6">
									<label class="form-label">연락처</label>
									<input class="form-control" type="text" placeholder="">
								</div>
								<div class="col-md-4">
									<label class="form-label">우편번호</label>
									<div class="input-group">
										<input class="form-control" type="text" placeholder="">
										<button class="btn btn-outline-secondary" type="button">찾기</button>
									</div>
								</div>
								<div class="col-md-8">
									<label class="form-label">주소</label>
									<input class="form-control" type="text" placeholder="">
								</div>
								<div class="col-12">
									<label class="form-label">상세 주소</label>
									<input class="form-control" type="text" placeholder="">
								</div>
								<div class="col-12">
									<label class="form-label">요청사항 (선택)</label>
									<input class="form-control" type="text" placeholder="예: 문 앞에 두고 가주세요">
								</div>
							</div>
						</div>
					</section>
		
					<!-- 3. 결제방법 -->
					<section class="sec mt-3">
						<div class="sec-hd section-head">
							<span class="num">3</span><span class="fw-semibold">결제방법</span>
						</div>
						<!-- 결제 UI -->
						<div id="payment-method"></div>
						<!-- 이용약관 UI -->
						<div id="agreement"></div>
					</section>
		
				</div>
		
				<!-- 우측: 결제 요약 -->
				<div class="col-lg-4">
					<div class="sec p-3 position-sticky" style="top: 80px;">
						<div class="d-flex justify-content-between mb-2">
							<span class="text-muted">상품금액</span>
							<strong><span id="prodPrice" th:text="${#numbers.formatInteger(product.productUnitPrice, 0)}">100,000</span>원</strong>
							<!-- th:text="${#numbers.formatInteger(item.productUnitPrice, 0)}" -->
						</div>
						<div class="d-flex justify-content-between mb-2">
							<span class="text-muted">배송비</span>
							<strong><span id="shipFee">3,000</span>원</strong>
							<!-- th:text="${#numbers.formatInteger(orderForm.shippingFee, 0)}" -->
						</div>
						<hr>
						<div class="d-flex justify-content-between fs-5">
							<span class="fw-bold">총 결제금액</span>
							<span class="fw-bold text-primary"><span id="grand">103,000</span>원</span>
							<!-- th:text="${#numbers.formatInteger(item.productUnitPrice + orderForm.shippingFee, 0)}" -->
						</div>
		
						<button type="button" class="btn btn-primary w-100 mt-3 paybtn" id="payment-button">
							결제하기
						</button>
					</div>
				</div>
			</div>
		</form>
	</div>

	<script>
		// 직거래 체크 시 배송지 입력 비활성 & 배송비 0원 처리
		(function () {
			const direct = document.getElementById('directTrade');
			const shipBox = document.getElementById('shipFields');
			const shipInputs = shipBox.querySelectorAll('input');
			const shipFeeEl = document.getElementById('shipFee');
			const prodPriceEl = document.getElementById('prodPrice');
			const grandEl = document.getElementById('grand');

			function format(n) {return n.toLocaleString();}
			function parseNum(txt) {return Number(String(txt).replace(/,/g, '')) || 0;}

			function recalc() {
				const prod = parseNum(prodPriceEl.textContent);
				const fee = parseNum(shipFeeEl.textContent);
				grandEl.textContent = format(prod + fee);
			}

			function toggle() {
				const useDirect = direct.checked;
				shipInputs.forEach(i => i.disabled = useDirect);
				shipBox.style.opacity = useDirect ? .6 : 1;
				shipFeeEl.textContent = useDirect ? '0' : shipFeeEl.dataset.orig || shipFeeEl.textContent;
				recalc();
			}

			shipFeeEl.dataset.orig = shipFeeEl.textContent;
			toggle();
			direct.addEventListener('change', toggle);
		})();

		// 결제 기능 부분(팝업)
		main();

		async function main() {
			const button = document.getElementById("payment-button");
			const coupon = document.getElementById("coupon-box");
			const amount = {
			  currency: "KRW",
			  value: 50000,
			};			
			// ------  결제위젯 초기화 ------
			const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
			const tossPayments = TossPayments(clientKey);
			// 회원 결제
			const customerKey = "dGUVtjKGjBVmrV4Yhyqgy";
			const widgets = tossPayments.widgets({
				customerKey,
			});
			// 비회원 결제
			// const widgets = tossPayments.widgets({ customerKey: TossPayments.ANONYMOUS });

			// ------ 주문의 결제 금액 설정 ------
			await widgets.setAmount(amount);

			await Promise.all([
				// ------  결제 UI 렌더링 ------
				widgets.renderPaymentMethods({
					selector: "#payment-method",
					variantKey: "DEFAULT",
				}),
				// ------  이용약관 UI 렌더링 ------
				widgets.renderAgreement({selector: "#agreement", variantKey: "AGREEMENT"}),
			]);

			// ------  주문서의 결제 금액이 변경되었을 경우 결제 금액 업데이트 ------
			coupon.addEventListener("change", async function () {
				if (coupon.checked) {
					await widgets.setAmount({
						currency: "KRW",
						value: 50000 - 5000,
					});

					return;
				}

				await widgets.setAmount({
					currency: "KRW",
					value: 50000,
				});
			});

			// ------ '결제하기' 버튼 누르면 결제창 띄우기 ------
			button.addEventListener("click", async function () {
				await widgets.requestPayment({
					orderId: generateRandomString(),
					orderName: "토스 티셔츠 외 2건",
					successUrl: window.location.origin + "/success.html",
					failUrl: window.location.origin + "/fail.html",
					customerEmail: "customer123@gmail.com",
					customerName: "김토스",
					customerMobilePhone: "01012341234",
				});
			});
			
			function generateRandomString() {
			  return window.btoa(Math.random()).slice(0, 20);
			}
		}
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
